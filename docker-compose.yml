version: '3.8'

services:
  # ===========================================
  # HARDHAT BLOCKCHAIN NODE
  # ===========================================
  blockchain:
    image: node:20-alpine
    container_name: fotomultas-blockchain
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - "8545:8545"
    command: sh -c "npm install && npx hardhat node --hostname 0.0.0.0"
    networks:
      - fotomultas-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # IPFS NODE
  # ===========================================
  ipfs:
    image: ipfs/kubo:latest
    container_name: fotomultas-ipfs
    environment:
      - IPFS_PROFILE=server
    ports:
      - "4001:4001"     # Swarm TCP
      - "4001:4001/udp" # Swarm UDP
      - "5001:5001"     # API
      - "8080:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-export:/export
    networks:
      - fotomultas-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5001/api/v0/version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # ===========================================
  # BACKEND API
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fotomultas-backend
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      
      # Blockchain
      - ETHEREUM_RPC_URL=http://blockchain:8545
      - ETHEREUM_PRIVATE_KEY=${ETHEREUM_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - ETHEREUM_CONTRACT_ADDRESS=${ETHEREUM_CONTRACT_ADDRESS}
      - ETHEREUM_GAS_LIMIT=300000
      - ETHEREUM_GAS_PRICE=20000000000
      
      # IPFS
      - IPFS_API_URL=http://ipfs:5001
      - IPFS_GATEWAY_URL=http://ipfs:8080
      - IPFS_TIMEOUT=30000
      - IPFS_RETRY_ATTEMPTS=3
      
      # Sync
      - SYNC_ENABLED=true
      - SYNC_INTERVAL=30000
      - SYNC_TIMEOUT=10000
      - SYNC_RETRY_ATTEMPTS=3
      
      # Security
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - JWT_EXPIRES_IN=24h
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX=100
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3001}
      - CORS_CREDENTIALS=true
      
      # APIs Externas
      - SIMIT_BASE_URL=${SIMIT_BASE_URL:-https://api.simit.com}
      - SIMIT_API_KEY=${SIMIT_API_KEY}
      - APITUDE_BASE_URL=${APITUDE_BASE_URL:-https://apitude.co/api}
      - APITUDE_API_KEY=${APITUDE_API_KEY}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=json
      - LOG_CONSOLE_ENABLED=true
      
    volumes:
      - ./logs:/app/logs
    depends_on:
      blockchain:
        condition: service_healthy
      ipfs:
        condition: service_healthy
    networks:
      - fotomultas-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

networks:
  fotomultas-network:
    driver: bridge

volumes:
  ipfs-data:
    driver: local
  ipfs-export:
    driver: local
